name: Xcode - Build and Artifact

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and analyse default scheme using xcodebuild command
    runs-on: macos-latest
    env:
      PROJECT: Ikuyo.xcodeproj
      SCHEME: Ikuyo
      CONFIGURATION: Release
      ARCHIVE_PATH: ${{ github.workspace }}/build/Ikuyo.xcarchive

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build Release archive (.xcarchive)
        shell: bash
        run: |
          xcodebuild \
            archive \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$ARCHIVE_PATH" \
            -derivedDataPath "$PWD/build" \
            CODE_SIGNING_ALLOWED=NO
      - name: Set app icon (best-effort)
        shell: bash
        run: |
          app_bundle=$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name "*.app" | head -n1)
          if [ -z "$app_bundle" ]; then
            echo "No .app bundle found in archive to set icon" >&2
            exit 1
          fi

          icns_path="$PWD/build/AppIcon.icns"
          icon_source=""

          # 1) Provided icns
          if [ -f AppIcon.icns ]; then
            cp AppIcon.icns "$icns_path"
            icon_source="AppIcon.icns (provided)"
          fi

          # 2) Build from AppIcon.png (generate an iconset and convert)
          if [ -z "$icon_source" ] && [ -f AppIcon.png ]; then
            workdir="$PWD/build/AppIcon.iconset"
            rm -rf "$workdir"
            mkdir -p "$workdir"
            for size in 16 32 128 256 512; do
              sips -z $size $size AppIcon.png --out "$workdir/icon_${size}x${size}.png" >/dev/null
              double=$((size*2))
              sips -z $double $double AppIcon.png --out "$workdir/icon_${size}x${size}@2x.png" >/dev/null
            done
            if iconutil -c icns "$workdir" -o "$icns_path"; then
              icon_source="AppIcon.png (generated)"
            fi
          fi

          # 3) AppIcon.iconset or AppIcon.icon
          if [ -z "$icon_source" ] && [ -d AppIcon.iconset ]; then
            if iconutil -c icns AppIcon.iconset -o "$icns_path"; then
              icon_source="AppIcon.iconset"
            fi
          fi
          if [ -z "$icon_source" ] && [ -d AppIcon.icon ]; then
            if iconutil -c icns AppIcon.icon -o "$icns_path"; then
              icon_source="AppIcon.icon"
            fi
          fi

          if [ ! -f "$icns_path" ]; then
            echo "No usable .icns generated (iconutil may not support the provided assets); keeping default icon." >&2
            exit 0
          fi

          mkdir -p "$app_bundle/Contents/Resources"
          cp "$icns_path" "$app_bundle/Contents/Resources/AppIcon.icns"
          plist="$app_bundle/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleIconFile AppIcon" "$plist" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :CFBundleIconFile string AppIcon" "$plist"
          echo "Applied app icon from $icon_source to $app_bundle"
      - name: Ad-hoc sign app and extensions
        shell: bash
        run: |
          app_bundle=$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name "*.app" | head -n1)
          if [ -z "$app_bundle" ]; then
            echo "No .app bundle found in archive for codesign" >&2
            exit 1
          fi
          echo "Ad-hoc signing $app_bundle"
          codesign -f -s "-" --deep --options runtime --timestamp=none "$app_bundle"
      - name: Package .app into zip
        id: package
        shell: bash
        run: |
          app_bundle=$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name "*.app" | head -n1)
          if [ -z "$app_bundle" ]; then
            echo "No .app bundle found in archive" >&2
            exit 1
          fi
          app_name=$(basename "$app_bundle")
          zip_path="$PWD/build/${app_name%.app}.zip"
          pushd "$(dirname "$app_bundle")" >/dev/null
          zip -r "$zip_path" "$app_name"
          popd >/dev/null
          echo "zip_path=$zip_path" >> "$GITHUB_OUTPUT"
          echo "app_name=$app_name" >> "$GITHUB_OUTPUT"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.app_name }}
          path: ${{ steps.package.outputs.zip_path }}
