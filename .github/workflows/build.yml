name: Xcode - Build and Artifact

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and analyse default scheme using xcodebuild command
    runs-on: macos-latest
    env:
      PROJECT: Ikuyo.xcodeproj
      SCHEME: Ikuyo
      CONFIGURATION: Release
      ARCHIVE_PATH: ${{ github.workspace }}/build/Ikuyo.xcarchive

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build Release archive (.xcarchive)
        shell: bash
        run: |
          xcodebuild \
            archive \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$ARCHIVE_PATH" \
            -derivedDataPath "$PWD/build" \
            CODE_SIGNING_ALLOWED=NO
      - name: Package .app into zip
        id: package
        shell: bash
        run: |
          app_bundle=$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name "*.app" | head -n1)
          if [ -z "$app_bundle" ]; then
            echo "No .app bundle found in archive" >&2
            exit 1
          fi
          app_name=$(basename "$app_bundle")
          zip_path="$PWD/build/${app_name%.app}.zip"
          pushd "$(dirname "$app_bundle")" >/dev/null
          zip -r "$zip_path" "$app_name"
          popd >/dev/null
          echo "zip_path=$zip_path" >> "$GITHUB_OUTPUT"
          echo "app_name=$app_name" >> "$GITHUB_OUTPUT"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.app_name }}
          path: ${{ steps.package.outputs.zip_path }}
